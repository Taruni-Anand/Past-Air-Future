<!DOCTYPE html>
<html lang="en">

<head>
	<title>PastAirFuture</title>

	<link rel='stylesheet' href='style.css'>
  <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

	<link href="https://fonts.googleapis.com/css?family=Poppins|Roboto+Slab|Slabo+27px" rel="stylesheet">
	
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- <script src="mongo.js"></script> -->
	<script src="http://www.webglearth.com/v2/api.js"></script>
		
	<script type="text/javascript">
		var electron = require('electron');
		var shell = electron.shell;
		var ipc = electron.ipcRenderer;
	</script>
  
  <script type='javascript' src='slider.js'></script>
  
	<script>
	
	// GLOBAL VARIABLES
		var myBool = false;
		var myD3Array = [4,3,7,1,3,1,6,5,6,4,8,3,7,1,3,4,6,1,4,7,2,9,4,2,4,6,1,2,5,1]



	// QUERY FUNCTION
	// ----------------------------------------------------------------------------------------------------------------------------------
	function runQuery(){
	
		var arrayOfAllDates = new Array()
		var singleMonthData = new Array()

		var MongoClient = require('mongodb').MongoClient
		var url = 'mongodb://localhost:27017/'

		var desiredCity = $('#selectCity').find(":selected").text();
		console.log(desiredCity)

		var desiredYear = $('#selectYear').find(":selected").text();
		console.log(desiredYear)
		var localregex = new RegExp(".*" + desiredYear + ".*")

		// for(k=1;k<10;k++){
		// 	for(p=1;p<10;p++){
		// 		var newlocalregex = new RegExp(".*" + desiredYear + "-0" + k + "-0" + p + ".*")
		// 		arrayOfAllDates.push(newlocalregex)
		// 		console.log(newlocalregex)
		// 	}
		// 	for(p=10;p<31;p++){
		// 		var newlocalregex = new RegExp(".*" + desiredYear + "-0" + k + "-" + p + ".*")
		// 		arrayOfAllDates.push(newlocalregex)
		// 		console.log(newlocalregex)
		// 	}
		// }

		// for(k=10;k<13;k++){
		// 	for(p=1;p<10;p++){
		// 		var newlocalregex = new RegExp(".*" + desiredYear + "-" + k + "-0" + p + ".*")
		// 		arrayOfAllDates.push(newlocalregex)
		// 		console.log(newlocalregex)
		// 	}
		// 	for(p=10;p<31;p++){
		// 		var newlocalregex = new RegExp(".*" + desiredYear + "-" + k + "-" + p + ".*")
		// 		arrayOfAllDates.push(newlocalregex)
		// 		console.log(newlocalregex)
		// 	}
		// }

		for(p=1;p<10;p++){
			var newlocalregex = new RegExp(".*" + desiredYear + "-05" + "-0" + p + ".*")
			arrayOfAllDates.push(newlocalregex)
		}
		for(p=10;p<31;p++){
			var newlocalregex = new RegExp(".*" + desiredYear + "-05" + "-" + p + ".*")
			arrayOfAllDates.push(newlocalregex)
		}

		console.log("AHHH", arrayOfAllDates)

		MongoClient.connect(url, { useNewUrlParser: true } ,function(err, db) {
			if (err) throw err
			var dbo = db.db('mydb')

			var query = { city: desiredCity }
				dbo.collection('things').find(query).toArray(function(err, result) {
					if (err) throw err
					addMarker(result[0].latitude,result[0].longitude)
					db.close()
				})


			for(i=0;i<arrayOfAllDates.length;i++){
				console.log("ARRAY DATES - ", i,  " - ", arrayOfAllDates[i])
				var query = { city: desiredCity, local: arrayOfAllDates[i] , parameter: "pm25"}
				dbo.collection('things').find(query).toArray(function(err, result) {
					if (err) throw err
					console.log("RESULSASDASNDAS", i ,result)
					db.close()
					
				})
			}
		})
  }

	// Grabs data from the API 
	// ----------------------------------------------------------------------------------------------------------------------------------
  $( document ).ready(function() {
    var url =
    'https://api.openaq.org/v1/countries'
    $.getJSON(url, showResults)


  $( "#slider-range" ).slider({
		range: true,
		min: 0,
		max: 10,
		values: [ 0, 10 ],
		slide: function( event, ui ) {
      console.log($('slider-range').slider("value"))
		}
	});
})

// D3 
function drawChart(data) {
   var svgWidth = 600, svgHeight = 400;
   var margin = { top: 20, right: 20, bottom: 30, left: 50 };
   var width = svgWidth - margin.left - margin.right;
   var height = svgHeight - margin.top - margin.bottom;
   var svg = d3.select('svg')
     .attr("width", svgWidth)
		 .attr("height", svgHeight);
}

// SLIDER
// ----------------------------------------------------------------------------------------------------------------------------------
$("#sliderNum").change(function() {
    $("#myRange").slider("value", $(this).val());
});

// Appends all country data to the dropdown
// ----------------------------------------------------------------------------------------------------------------------------------
function showResults(response) {
  for (i = 0; i < response.results.length; i++) { 
    // $('#selectCountry').append('<option>'+response.results[i].name+ " (" + response.results[i].code + ") " + '</option>')
    $('#selectCountry').append('<option>' + response.results[i].code + '</option>')
  }
}

// Appends all city data to the dropdown
// ----------------------------------------------------------------------------------------------------------------------------------
function showResults2(response) {
  $('#selectCity').empty()
  for (i = 0; i < response.results.length; i++) { 
    $('#selectCity').append('<option>'+response.results[i].city+'</option>')
  }
}
 
// After selecting a country, runs another call to the api to get all cities within that country
// ----------------------------------------------------------------------------------------------------------------------------------
$(document).on('change', '#selectCountry', function(e) {
    console.log(this.options[e.target.selectedIndex].text);
    $('#countryText').text(this.options[e.target.selectedIndex].text)

    var url = 'https://api.openaq.org/v1/locations?country=' + this.options[e.target.selectedIndex].text
    $.getJSON(url, showResults2)
});

$(document).on('change', '#selectCity', function(e) {
    $('#cityText').text(this.options[e.target.selectedIndex].text)
});

$(document).on('change', '#selectYear', function(e) {
    $('#countryYear').text(this.options[e.target.selectedIndex].text)
});

// Earth Visualization

var earth;

function initialize() {
	earth = new WE.map('earth_div');
	earth.setView([46.8011, 8.2266], 1);
	// WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
	// attribution: 'NASA'
	// }).addTo(earth);
	WE.tileLayer('https://webglearth.github.io/webglearth2-offline/{z}/{x}/{y}.jpg', {
		tileSize: 256,
		bounds: [[-85, -180], [85, 180]],
		minZoom: 0,
		maxZoom: 16,
		tms: true
	}).addTo(earth);

	// Start a simple rotation animation
	var before = null;
	requestAnimationFrame(function animate(now) {
		var c = earth.getPosition();
		var elapsed = before? now - before: 0;
		before = now;
		earth.setCenter([c[0], c[1] + 0.1*(elapsed/60)]);
		requestAnimationFrame(animate);
	});
}

function addMarker(long,lat){
	var marker = WE.marker([long, lat]).addTo(earth);
	marker.bindPopup("<b>Hello world!</b><br>I am a popup.<br /><span style='font-size:10px;color:#999'>Tip: Another popup is hidden in Cairo..</span>", {maxWidth: 150, closeButton: true}).openPopup();
}

  </script>
</head>

<body id="page-info"  onload="initialize()">
	<main class="title">
		<h1>
			Past Air Future 
		</h1>
	</main>
	
	<button id="button1" onclick="runQuery()"><h2>HELLO</h2></button>

	<div id="container">
		<div class ="locations">
			<div class = "list">
          <h3 id="countryText">County Name</h3>
          <h3 id="cityText">Country Code</h3>
          <h3 id="countryYear">County Year</h3>
          
          <form id="myForm">
              <select id="selectCountry">
                <option>Choose a country</option>
              </select>
            </form>

          <form id="myForm">
            <select id="selectCity">
              <option>Choose a city</option>
            </select>
          </form>
          
          <form id="myForm">
						<!-- June 29 2015 - April 9 2019 -->
            <select id="selectYear">
							<option>Choose the year</option>
							<option>2015</option>
							<option>2016</option>
							<option>2017</option>
							<option>2018</option>
							<option>2019</option>
            </select>
          </form>

			</div>
		</div>

		<div class ="map">
			<div id="earth_div"></div>
			<div>
				<svg></svg>
			</div>
		</div>
	</div>

	<div class ="timeline">
      <div class="slidecontainer">
					<p>Slider Number: </p> 
					<input type="range" min="1" max="12" value="9" class="slider" id="myRange">
        </div>
	</div>
</body>
</html>